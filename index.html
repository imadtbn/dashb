<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>لوحة التحكم — مشتلة السلام</title>

  <!-- خط عربي أنيق -->
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet" />
  <!-- أيقونات -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" />
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <style>
    :root{
      --primary:#2e7d32; --primary-2:#1b5e20; --accent:#81c784; --muted:#6b7280;
      --bg:#f5f6f4; --card:#ffffff; --danger:#d32f2f; --warning:#f59e0b; --radius:16px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:'Tajawal',Arial,system-ui,sans-serif;background:var(--bg);color:#111}

    /* رأس الصفحة */
    header{position:sticky;top:0;z-index:40;background:linear-gradient(135deg,var(--primary),#4caf50);color:#fff}
    .topbar{max-width:1200px;margin:auto;display:flex;align-items:center;justify-content:space-between;padding:12px 16px}
    .brand{display:flex;gap:10px;align-items:center;font-weight:800;letter-spacing:.3px}
    .brand i{background:rgba(255,255,255,.15);padding:10px;border-radius:14px}
    .actions{display:flex;gap:8px}
    .btn{appearance:none;border:0;cursor:pointer;border-radius:12px;padding:10px 14px;background:#fff;color:#1f2937;font-weight:600;box-shadow:0 1px 2px rgba(0,0,0,.08)}
    .btn:hover{filter:brightness(.98)}
    .btn-primary{background:var(--card);color:var(--primary);border:2px solid #e8f5e9}

    /* تبويبات */
    .tabs{background:#ffffff;border-bottom:1px solid #eef2f7}
    .tabs-inner{max-width:1200px;margin:auto;display:flex;gap:6px;overflow:auto;padding:6px 10px}
    .tab{white-space:nowrap;border:0;background:transparent;padding:10px 14px;border-radius:999px;color:#334155;font-weight:700}
    .tab i{margin-left:6px}
    .tab.active{background:#e8f5e9;color:var(--primary);box-shadow:inset 0 0 0 2px #cdebd3}

    /* الحاوية */
    main{max-width:1200px;margin:16px auto;padding:0 12px}

    /* بطاقات */
    .card{background:var(--card);border-radius:var(--radius);box-shadow:0 4px 18px rgba(0,0,0,.06);padding:16px;margin-bottom:14px}
    .card h2{margin:0 0 12px 0;font-size:1.2rem;color:#0f172a}

    /* نماذج */
    .form-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:10px}
    .form-grid .field{display:flex;flex-direction:column}
    label{font-weight:700;font-size:.9rem;color:#334155;margin-bottom:6px}
    input,select,textarea{width:100%;border:1px solid #e5e7eb;border-radius:12px;padding:10px 12px;font-family:inherit}
    textarea{min-height:88px}
    .btn-save{background:var(--primary);color:#fff;border:0;border-radius:12px;padding:10px 14px;font-weight:700}
    .btn-save:hover{background:var(--primary-2)}
    .btn-outline{background:#fff;border:1px solid #e5e7eb}
    .btn-danger{background:var(--danger);color:#fff}

    /* جداول */
    .table-wrap{overflow:auto;border:1px solid #eef2f7;border-radius:14px}
    table{width:100%;border-collapse:collapse;min-width:760px}
    th,td{padding:12px;border-bottom:1px solid #f1f5f9;text-align:right;vertical-align:middle}
    th{background:#f7faf7;color:#065f46;font-weight:800}
    tr:hover td{background:#fafafa}
    .row-actions{display:flex;gap:8px;justify-content:flex-start}

    /* شبكات الإحصائيات */
    .stats-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:14px}

    /* تجاوب */
    @media(max-width:980px){ .form-grid{grid-template-columns:repeat(2,1fr)} }
    @media(max-width:640px){ .form-grid{grid-template-columns:1fr} .brand span{display:none} .btn{padding:8px 10px} }
  </style>
</head>
<body>
  <header>
    <div class="topbar">
      <div class="brand"><i class="fas fa-seedling"></i><span>لوحة التحكم — مشتلة السلام</span></div>
      <div class="actions">
        <button id="refreshBtn" class="btn btn-primary"><i class="fa-solid fa-rotate"></i> تحديث</button>
      </div>
    </div>
    <div class="tabs">
      <div class="tabs-inner">
        <button class="tab active" data-tab="products"><i class="fa-solid fa-box"></i>المنتجات</button>
        <button class="tab" data-tab="categories"><i class="fa-solid fa-tags"></i>الفئات</button>
        <button class="tab" data-tab="orders"><i class="fa-solid fa-receipt"></i>الطلبات</button>
        <button class="tab" data-tab="stats"><i class="fa-solid fa-chart-column"></i>الإحصائيات</button>
      </div>
    </div>
  </header>

  <main>
    <!-- المنتجات -->
    <section id="products" class="card">
      <h2>إضافة/إدارة المنتجات</h2>
      <div class="card" style="padding-top:8px">
        <div class="form-grid">
          <div class="field"><label>اسم المنتج</label><input id="p_name" placeholder="مثال: شتلة زيتون" /></div>
          <div class="field"><label>الفئة</label><select id="p_category"></select></div>
          <div class="field"><label>السعر (دج)</label><input id="p_price" type="number" min="0" step="1" /></div>
          <div class="field"><label>المخزون</label><input id="p_stock" type="number" min="0" step="1" /></div>
          <div class="field" style="grid-column:1 / -1"><label>رابط الصورة</label><input id="p_image" placeholder="https://" /></div>
          <div class="field" style="grid-column:1 / -1"><label>وصف</label><textarea id="p_desc" placeholder="وصف مختصر"></textarea></div>
        </div>
        <div style="display:flex;gap:10px;margin-top:10px">
          <button id="addProductBtn" class="btn-save"><i class="fa-solid fa-plus"></i> إضافة المنتج</button>
          <button id="resetProductForm" class="btn btn-outline"><i class="fa-regular fa-circle-xmark"></i> تفريغ</button>
        </div>
      </div>

      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>#</th>
              <th>الاسم</th>
              <th>الفئة</th>
              <th>السعر</th>
              <th>المخزون</th>
              <th>إجراءات</th>
            </tr>
          </thead>
          <tbody id="productsBody"></tbody>
        </table>
      </div>
    </section>

    <!-- الفئات -->
    <section id="categories" class="card" hidden>
      <h2>إدارة الفئات</h2>
      <div class="card">
        <div class="form-grid">
          <div class="field"><label>اسم الفئة</label><input id="c_name" placeholder="مثال: أشجار مثمرة" /></div>
          <div class="field" style="grid-column:1 / -1"><label>وصف</label><input id="c_desc" placeholder="وصف مختصر" /></div>
        </div>
        <div style="display:flex;gap:10px;margin-top:10px">
          <button id="addCategoryBtn" class="btn-save"><i class="fa-solid fa-plus"></i> إضافة فئة</button>
        </div>
      </div>

      <div class="table-wrap">
        <table>
          <thead>
            <tr><th>#</th><th>الفئة</th><th>الوصف</th><th>إجراءات</th></tr>
          </thead>
          <tbody id="categoriesBody"></tbody>
        </table>
      </div>
    </section>

    <!-- الطلبات -->
    <section id="orders" class="card" hidden>
      <h2>طلبات الزبائن</h2>
      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>#</th>
              <th>العميل</th>
              <th>الهاتف</th>
              <th>المنتجات</th>
              <th>الإجمالي</th>
              <th>الحالة</th>
              <th>تاريخ</th>
              <th>إجراءات</th>
            </tr>
          </thead>
          <tbody id="ordersBody"></tbody>
        </table>
      </div>
    </section>

    <!-- الإحصائيات -->
    <section id="stats" class="card" hidden>
      <h2>الإحصائيات</h2>
      <div class="stats-grid">
        <div class="card"><canvas id="ordersMonthly"></canvas></div>
        <div class="card"><canvas id="topProducts"></canvas></div>
      </div>
    </section>
  </main>

  <script>
    // ===== إعدادات API =====
    const API_URL = "https://script.google.com/macros/s/AKfycbwf3RgEZ31JDu7JLv9t_4aMEZR2mXJ2kmlFfmDiYDTDQw1lgeuBoVpiAYgcG2Y2XImwsQ/exec"; // Web App URL

    // واجهة موحدة للطلبات
    async function apiGet(sheet){
      const url = `${API_URL}?sheet=${encodeURIComponent(sheet)}`;
      const res = await fetch(url);
      if(!res.ok) throw new Error('GET failed');
      return res.json();
    }
    async function apiPost(payload){
      const res = await fetch(API_URL,{method:'POST',body:JSON.stringify(payload)});
      if(!res.ok) throw new Error('POST failed');
      return res.text();
    }

    // تبويبات
    const tabButtons = document.querySelectorAll('.tab');
    tabButtons.forEach(btn=>btn.addEventListener('click',()=>{
      tabButtons.forEach(b=>b.classList.remove('active'));
      btn.classList.add('active');
      const id = btn.dataset.tab;
      document.querySelectorAll('main > section').forEach(s=>s.hidden=true);
      document.getElementById(id).hidden = false;
    }));

    // تحميل أولي + زر تحديث
    document.getElementById('refreshBtn').addEventListener('click', init);

    // بيانات في الذاكرة
    let PRODUCTS=[], CATEGORIES=[], ORDERS=[];

    async function init(){
      try{
        // ملاحظة: نتوقع من تطبيق الويب في Apps Script أن يدعم ?sheet=products / categories / orders
        const [products,categories,orders] = await Promise.all([
          apiGet('products'), apiGet('categories'), apiGet('orders')
        ]);
        PRODUCTS = normalizeRows(products); // مصفوفة كائنات
        CATEGORIES = normalizeRows(categories);
        ORDERS = normalizeRows(orders);

        renderCategoriesSelect();
        renderProductsTable();
        renderCategoriesTable();
        renderOrdersTable();
        renderCharts();
      }catch(err){
        console.error(err);
        alert('تعذر الجلب من Google Sheets. يرجى التأكد من صلاحيات Web App وبنية الأوراق.');
      }
    }

    // تحويل مصفوفة الصفوف إلى كائنات إن كانت مصفوفات خام
    function normalizeRows(rows){
      // إذا عاد السيرفر بالفعل ككائنات فنعيدها كما هي
      if(rows && rows.length && !Array.isArray(rows[0])) return rows;
      if(!rows || !rows.length) return [];
      const headers = rows[0];
      const out=[];
      for(let i=1;i<rows.length;i++){
        const obj={};
        headers.forEach((h,idx)=>obj[h]=rows[i][idx]);
        out.push(obj);
      }
      return out;
    }

    // ===== المنتجات =====
    function renderCategoriesSelect(){
      const sel = document.getElementById('p_category');
      sel.innerHTML = '<option value="">— اختر فئة —</option>' + CATEGORIES.map(c=>`<option value="${c.name||c["name"]||c["اسم الفئة"]||c["category"]}">${c.name||c["اسم الفئة"]||c["category"]}</option>`).join('');
    }

    function renderProductsTable(){
      const body = document.getElementById('productsBody');
      body.innerHTML = '';
      PRODUCTS.forEach((p,idx)=>{
        const id = p.id||p.ID||p["Id"]||p["المعرف"];
        const name = p.name||p["الاسم"];
        const category = p.category||p["الفئة"];
        const price = p.price||p["السعر"];
        const stock = p.stock||p["المخزون"]||0;
        body.insertAdjacentHTML('beforeend',`
          <tr>
            <td>${idx+1}</td>
            <td>${name||''}</td>
            <td>${category||''}</td>
            <td>${price||''}</td>
            <td>${stock||''}</td>
            <td class="row-actions">
              <button class="btn" onclick="editProduct('${id}')"><i class='fa-regular fa-pen-to-square'></i> تعديل</button>
              <button class="btn btn-danger" onclick="deleteProduct('${id}')"><i class='fa-regular fa-trash-can'></i> حذف</button>
            </td>
          </tr>
        `);
      });
    }

    // إضافة منتج
    document.getElementById('addProductBtn').addEventListener('click', async ()=>{
      const payload = {
        action:'addProduct',
        name: document.getElementById('p_name').value.trim(),
        category: document.getElementById('p_category').value,
        price: +document.getElementById('p_price').value||0,
        stock: +document.getElementById('p_stock').value||0,
        image: document.getElementById('p_image').value.trim(),
        desc: document.getElementById('p_desc').value.trim(),
      };
      if(!payload.name || !payload.category){ return alert('الاسم والفئة مطلوبان'); }
      try{
        const msg = await apiPost(payload);
        alert(msg||'تمت الإضافة');
        document.getElementById('resetProductForm').click();
        init();
      }catch(e){ alert('تعذر الإضافة'); }
    });
    document.getElementById('resetProductForm').addEventListener('click',()=>{
      ['p_name','p_category','p_price','p_stock','p_image','p_desc'].forEach(id=>document.getElementById(id).value='');
    });

    // تعديل/حذف منتج
    window.editProduct = async function(id){
      const p = PRODUCTS.find(x=> (x.id||x.ID)==id);
      if(!p){return alert('لم يتم العثور على المنتج');}
      const newPrice = prompt('أدخل السعر الجديد', p.price||p["السعر"]||0);
      if(newPrice===null) return;
      const newStock = prompt('أدخل المخزون الجديد', p.stock||p["المخزون"]||0);
      if(newStock===null) return;
      try{
        const msg = await apiPost({action:'updateProduct', id, price:+newPrice, stock:+newStock});
        alert(msg||'تم التحديث');
        init();
      }catch(e){ alert('تعذر التحديث'); }
    }
    window.deleteProduct = async function(id){
      if(!confirm('تأكيد حذف المنتج؟')) return;
      try{
        const msg = await apiPost({action:'deleteProduct', id});
        alert(msg||'تم الحذف');
        init();
      }catch(e){ alert('تعذر الحذف'); }
    }

    // ===== الفئات =====
    function renderCategoriesTable(){
      const body = document.getElementById('categoriesBody');
      body.innerHTML = '';
      CATEGORIES.forEach((c,idx)=>{
        const id = c.id||c.ID||c["Id"];
        const name = c.name||c["اسم الفئة"]||c["category"];
        const desc = c.desc||c["الوصف"]||'';
        body.insertAdjacentHTML('beforeend',`
          <tr>
            <td>${idx+1}</td>
            <td>${name||''}</td>
            <td>${desc||''}</td>
            <td class="row-actions">
              <button class="btn btn-danger" onclick="deleteCategory('${id}')"><i class='fa-regular fa-trash-can'></i> حذف</button>
            </td>
          </tr>
        `);
      });
    }

    document.getElementById('addCategoryBtn').addEventListener('click', async ()=>{
      const name = document.getElementById('c_name').value.trim();
      const desc = document.getElementById('c_desc').value.trim();
      if(!name) return alert('اسم الفئة مطلوب');
      try{
        const msg = await apiPost({action:'addCategory', name, desc});
        alert(msg||'تمت إضافة الفئة');
        document.getElementById('c_name').value='';
        document.getElementById('c_desc').value='';
        init();
      }catch(e){ alert('تعذر إضافة الفئة'); }
    });

    window.deleteCategory = async function(id){
      if(!confirm('تأكيد حذف الفئة؟ سيؤثر على المنتجات المرتبطة.')) return;
      try{
        const msg = await apiPost({action:'deleteCategory', id});
        alert(msg||'تم حذف الفئة');
        init();
      }catch(e){ alert('تعذر حذف الفئة'); }
    }

    // ===== الطلبات =====
    function renderOrdersTable(){
      const body = document.getElementById('ordersBody');
      body.innerHTML='';
      ORDERS.forEach((o,idx)=>{
        const id = o.id||o.ID;
        const name = o.customerName||o["اسم العميل"]||o["العميل"];
        const phone = (o.phone||o["الهاتف"]||'').toString();
        const items = o.items||o["المنتجات"]||'';
        const total = o.total||o["الإجمالي"]||o["المجموع"]||'';
        const status = o.status||o["الحالة"]||'جديد';
        const date = o.date||o["التاريخ"]||o["تاريخ"]||'';
        const wa = normalizeDZ(phone);
        body.insertAdjacentHTML('beforeend',`
          <tr>
            <td>${idx+1}</td>
            <td>${name||''}</td>
            <td><a href="https://wa.me/${wa}?text=${encodeURIComponent('مرحباً، بخصوص طلبكم من مشتلة السلام: '+items+' — الإجمالي: '+total)}" target="_blank">${phone}</a></td>
            <td>${items}</td>
            <td>${total}</td>
            <td><span class="badge">${status}</span></td>
            <td>${formatDate(date)}</td>
            <td class="row-actions">
              <button class="btn" onclick="updateOrder('${id}','قيد المعالجة')">قيد المعالجة</button>
              <button class="btn" onclick="updateOrder('${id}','مكتمل')">مكتمل</button>
            </td>
          </tr>
        `);
      });
    }

    function normalizeDZ(phone){
      // يحول 069xxxx إلى 21369xxxx للتوافق مع wa.me
      let p = phone.replace(/\D/g,'');
      if(p.startsWith('0')) p = '213'+p.slice(1);
      if(p.startsWith('00213')) p = '213'+p.slice(5);
      return p;
    }
    function formatDate(d){ try{ return new Date(d).toLocaleDateString('ar-DZ'); }catch{ return d||'' } }

    async function updateOrder(id,status){
      try{
        const msg = await apiPost({action:'updateOrder', id, status});
        alert(msg||'تم تحديث الحالة');
        init();
      }catch(e){ alert('تعذر تحديث الطلب'); }
    }

    // ===== الرسوم البيانية =====
    let chartOrdersMonthly, chartTopProducts;
    function renderCharts(){
      // تدمير قديم
      if(chartOrdersMonthly) chartOrdersMonthly.destroy();
      if(chartTopProducts) chartTopProducts.destroy();

      // 1) عدد الطلبات شهريًا
      const monthly = {};
      ORDERS.forEach(o=>{
        const d = new Date(o.date||o["التاريخ"]||o["تاريخ"]||Date.now());
        const key = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
        monthly[key] = (monthly[key]||0)+1;
      });
      const labelsM = Object.keys(monthly).sort();
      const dataM = labelsM.map(k=>monthly[k]);
      chartOrdersMonthly = new Chart(document.getElementById('ordersMonthly'),{
        type:'line',
        data:{ labels:labelsM, datasets:[{ label:'الطلبات شهريًا', data:dataM }] },
        options:{ responsive:true, plugins:{ legend:{ display:true } } }
      });

      // 2) أكثر المنتجات تكرارًا في الطلبات
      const counts = {};
      ORDERS.forEach(o=>{
        const raw = (o.items||o["المنتجات"]||'');
        raw.split(',').map(s=>s.trim()).filter(Boolean).forEach(name=>{
          // يحذف الكميات مثل ×2
          const base = name.replace(/×\s*\d+/,'').trim();
          counts[base]=(counts[base]||0)+1;
        })
      });
      const labelsT = Object.keys(counts);
      const dataT = labelsT.map(k=>counts[k]);
      chartTopProducts = new Chart(document.getElementById('topProducts'),{
        type:'bar',
        data:{ labels:labelsT, datasets:[{ label:'تكرار البيع', data:dataT }] },
        options:{ indexAxis: labelsT.length>6 ? 'y' : 'x', plugins:{ legend:{display:true} } }
      });
    }

    // تشغيل أولي
    init();
  </script>
</body>
</html>
