<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… â€” Ù…Ø´ØªÙ„Ø© Ø§Ù„Ø³Ù„Ø§Ù…</title>

  <!-- Ø®Ø· Ø¹Ø±Ø¨ÙŠ Ø£Ù†ÙŠÙ‚ -->
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet" />
  <!-- Ø£ÙŠÙ‚ÙˆÙ†Ø§Øª -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" />
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <style>
    :root{
      --primary:#2e7d32; --primary-2:#1b5e20; --accent:#81c784; --muted:#6b7280;
      --bg:#f5f6f4; --card:#ffffff; --danger:#d32f2f; --warning:#f59e0b; --radius:16px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:'Tajawal',Arial,system-ui,sans-serif;background:var(--bg);color:#111}

    /* Ø±Ø£Ø³ Ø§Ù„ØµÙØ­Ø© */
    header{position:sticky;top:0;z-index:40;background:linear-gradient(135deg,var(--primary),#4caf50);color:#fff}
    .topbar{max-width:1200px;margin:auto;display:flex;align-items:center;justify-content:space-between;padding:12px 16px}
    .brand{display:flex;gap:10px;align-items:center;font-weight:800;letter-spacing:.3px}
    .brand i{background:rgba(255,255,255,.15);padding:10px;border-radius:14px}
    .actions{display:flex;gap:8px}
    .btn{appearance:none;border:0;cursor:pointer;border-radius:12px;padding:10px 14px;background:#fff;color:#1f2937;font-weight:600;box-shadow:0 1px 2px rgba(0,0,0,.08);transition:all 0.2s ease}
    .btn:hover{filter:brightness(.98);transform:translateY(-1px)}
    .btn-primary{background:var(--card);color:var(--primary);border:2px solid #e8f5e9}
    .btn-group{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}

    /* ØªØ¨ÙˆÙŠØ¨Ø§Øª */
    .tabs{background:#ffffff;border-bottom:1px solid #eef2f7}
    .tabs-inner{max-width:1200px;margin:auto;display:flex;gap:6px;overflow:auto;padding:6px 10px}
    .tab{white-space:nowrap;border:0;background:transparent;padding:10px 14px;border-radius:999px;color:#334155;font-weight:700;transition:all 0.2s ease}
    .tab i{margin-left:6px}
    .tab.active{background:#e8f5e9;color:var(--primary);box-shadow:inset 0 0 0 2px #cdebd3}

    /* Ø§Ù„Ø­Ø§ÙˆÙŠØ© */
    main{max-width:1200px;margin:16px auto;padding:0 12px}

    /* Ø¨Ø·Ø§Ù‚Ø§Øª */
    .card{background:var(--card);border-radius:var(--radius);box-shadow:0 4px 18px rgba(0,0,0,.06);padding:16px;margin-bottom:14px}
    .card h2{margin:0 0 12px 0;font-size:1.2rem;color:#0f172a}

    /* Ù†Ù…Ø§Ø°Ø¬ */
    .form-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:10px}
    .form-grid .field{display:flex;flex-direction:column}
    label{font-weight:700;font-size:.9rem;color:#334155;margin-bottom:6px}
    input,select,textarea{width:100%;border:1px solid #e5e7eb;border-radius:12px;padding:10px 12px;font-family:inherit}
    textarea{min-height:88px}
    .btn-save{background:var(--primary);color:#fff;border:0;border-radius:12px;padding:10px 14px;font-weight:700}
    .btn-save:hover{background:var(--primary-2)}
    .btn-outline{background:#fff;border:1px solid #e5e7eb}
    .btn-danger{background:var(--danger);color:#fff}
    .btn-warning{background:var(--warning);color:#fff}

    /* Ø¬Ø¯Ø§ÙˆÙ„ */
    .table-wrap{overflow:auto;border:1px solid #eef2f7;border-radius:14px}
    table{width:100%;border-collapse:collapse;min-width:760px}
    th,td{padding:12px;border-bottom:1px solid #f1f5f9;text-align:right;vertical-align:middle}
    th{background:#f7faf7;color:#065f46;font-weight:800}
    tr:hover td{background:#fafafa}
    .row-actions{display:flex;gap:8px;justify-content:flex-start}

    /* Ø´Ø¨ÙƒØ§Øª Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª */
    .stats-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:14px}

    /* Ù…ÙˆØ¯Ø§Ù„ Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯ */
    .modal{display:none;position:fixed;z-index:50;left:0;top:0;width:100%;height:100%;background-color:rgba(0,0,0,0.5)}
    .modal-content{background-color:#fefefe;margin:5% auto;padding:20px;border-radius:var(--radius);max-width:600px;box-shadow:0 4px 20px rgba(0,0,0,0.15)}
    .close{color:#aaa;float:left;font-size:28px;font-weight:bold;cursor:pointer}
    .close:hover{color:#000}
    .import-instructions{background:#f8f9fa;padding:12px;border-radius:8px;margin-bottom:12px}
    .import-area{width:100%;min-height:150px;border:1px dashed #ccc;border-radius:8px;padding:12px;margin:12px 0;font-family:monospace}

    /* ØªØ­Ø³ÙŠÙ†Ø§Øª Ø§Ù„ØªØ­Ù…ÙŠÙ„ ÙˆØ§Ù„Ø±Ø³Ø§Ø¦Ù„ */
    .loading{display:none;text-align:center;padding:20px;color:var(--primary)}
    .loading i{animation:spin 1s linear infinite;font-size:2rem}
    @keyframes spin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}
    .alert{padding:12px;border-radius:8px;margin:10px 0}
    .alert-success{background:#d4edda;color:#155724}
    .alert-error{background:#f8d7da;color:#721c24}

    /* ØªØ¬Ø§ÙˆØ¨ */
    @media(max-width:980px){ .form-grid{grid-template-columns:repeat(2,1fr)} }
    @media(max-width:640px){ 
      .form-grid{grid-template-columns:1fr} 
      .brand span{display:none} 
      .btn{padding:8px 10px} 
      .btn-group{flex-direction:column;align-items:stretch}
      .row-actions{flex-direction:column}
      .modal-content{width:95%;margin:10% auto}
    }
  </style>
</head>
<body>
  <header>
    <div class="topbar">
      <div class="brand"><i class="fas fa-seedling"></i><span>Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… â€” Ù…Ø´ØªÙ„Ø© Ø§Ù„Ø³Ù„Ø§Ù…</span></div>
      <div class="actions">
        <button id="refreshBtn" class="btn btn-primary"><i class="fa-solid fa-rotate"></i> ØªØ­Ø¯ÙŠØ«</button>
      </div>
    </div>
    <div class="tabs">
      <div class="tabs-inner">
        <button class="tab active" data-tab="products"><i class="fa-solid fa-box"></i>Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</button>
        <button class="tab" data-tab="categories"><i class="fa-solid fa-tags"></i>Ø§Ù„ÙØ¦Ø§Øª</button>
        <button class="tab" data-tab="orders"><i class="fa-solid fa-receipt"></i>Ø§Ù„Ø·Ù„Ø¨Ø§Øª</button>
        <button class="tab" data-tab="stats"><i class="fa-solid fa-chart-column"></i>Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª</button>
      </div>
    </div>
  </header>

  <main>
    <!-- Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„ØªØ­Ù…ÙŠÙ„ -->
    <div id="loading" class="loading" hidden>
      <i class="fas fa-spinner"></i>
      <p>Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</p>
    </div>

    <!-- Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª -->
    <section id="products" class="card">
      <h2>Ø¥Ø¶Ø§ÙØ©/Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</h2>
      <div class="card" style="padding-top:8px">
        <div class="form-grid">
          <div class="field"><label>Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬</label><input id="p_name" placeholder="Ù…Ø«Ø§Ù„: Ø´ØªÙ„Ø© Ø²ÙŠØªÙˆÙ†" /></div>
          <div class="field"><label>Ø§Ù„ÙØ¦Ø©</label><select id="p_category"></select></div>
          <div class="field"><label>Ø§Ù„Ø³Ø¹Ø± (Ø¯Ø¬)</label><input id="p_price" type="number" min="0" step="1" /></div>
          <div class="field"><label>Ø§Ù„Ù…Ø®Ø²ÙˆÙ†</label><input id="p_stock" type="number" min="0" step="1" /></div>
          <div class="field" style="grid-column:1 / -1"><label>Ø±Ø§Ø¨Ø· Ø§Ù„ØµÙˆØ±Ø©</label><input id="p_image" placeholder="https://" /></div>
          <div class="field" style="grid-column:1 / -1"><label>ÙˆØµÙ</label><textarea id="p_desc" placeholder="ÙˆØµÙ Ù…Ø®ØªØµØ±"></textarea></div>
        </div>
        <div class="btn-group">
          <button id="addProductBtn" class="btn-save"><i class="fa-solid fa-plus"></i> Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù†ØªØ¬</button>
          <button id="resetProductForm" class="btn btn-outline"><i class="fa-regular fa-circle-xmark"></i> ØªÙØ±ÙŠØº</button>
          <button id="importProductsBtn" class="btn btn-warning"><i class="fa-solid fa-file-import"></i> Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</button>
        </div>
      </div>

      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>#</th>
              <th>Ø§Ù„Ø§Ø³Ù…</th>
              <th>Ø§Ù„ÙØ¦Ø©</th>
              <th>Ø§Ù„Ø³Ø¹Ø±</th>
              <th>Ø§Ù„Ù…Ø®Ø²ÙˆÙ†</th>
              <th>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
            </tr>
          </thead>
          <tbody id="productsBody">
            <tr><td colspan="6" style="text-align:center;padding:20px">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</td></tr>
          </tbody>
        </table>
      </div>
    </section>

    <!-- Ø§Ù„ÙØ¦Ø§Øª -->
    <section id="categories" class="card" hidden>
      <h2>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ÙØ¦Ø§Øª</h2>
      <div class="card">
        <div class="form-grid">
          <div class="field"><label>Ø§Ø³Ù… Ø§Ù„ÙØ¦Ø©</label><input id="c_name" placeholder="Ù…Ø«Ø§Ù„: Ø£Ø´Ø¬Ø§Ø± Ù…Ø«Ù…Ø±Ø©" /></div>
          <div class="field" style="grid-column:1 / -1"><label>ÙˆØµÙ</label><input id="c_desc" placeholder="ÙˆØµÙ Ù…Ø®ØªØµØ±" /></div>
        </div>
        <div class="btn-group">
          <button id="addCategoryBtn" class="btn-save"><i class="fa-solid fa-plus"></i> Ø¥Ø¶Ø§ÙØ© ÙØ¦Ø©</button>
        </div>
      </div>

      <div class="table-wrap">
        <table>
          <thead>
            <tr><th>#</th><th>Ø§Ù„ÙØ¦Ø©</th><th>Ø§Ù„ÙˆØµÙ</th><th>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th></tr>
          </thead>
          <tbody id="categoriesBody">
            <tr><td colspan="4" style="text-align:center;padding:20px">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</td></tr>
          </tbody>
        </table>
      </div>
    </section>

    <!-- Ø§Ù„Ø·Ù„Ø¨Ø§Øª -->
    <section id="orders" class="card" hidden>
      <h2>Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø²Ø¨Ø§Ø¦Ù†</h2>
      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>#</th>
              <th>Ø§Ù„Ø¹Ù…ÙŠÙ„</th>
              <th>Ø§Ù„Ù‡Ø§ØªÙ</th>
              <th>Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</th>
              <th>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th>
              <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
              <th>ØªØ§Ø±ÙŠØ®</th>
              <th>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
            </tr>
          </thead>
          <tbody id="ordersBody">
            <tr><td colspan="8" style="text-align:center;padding:20px">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</td></tr>
          </tbody>
        </table>
      </div>
    </section>

    <!-- Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª -->
    <section id="stats" class="card" hidden>
      <h2>Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª</h2>
      <div class="stats-grid">
        <div class="card"><canvas id="ordersMonthly"></canvas></div>
        <div class="card"><canvas id="topProducts"></canvas></div>
      </div>
    </section>
  </main>

  <!-- Ù…ÙˆØ¯Ø§Ù„ Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª -->
  <div id="importModal" class="modal">
    <div class="modal-content">
      <span class="close">&times;</span>
      <h2>Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</h2>
      <div class="import-instructions">
        <p>ğŸ“‹ <strong>ØªØ¹Ù„ÙŠÙ…Ø§Øª Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯:</strong></p>
        <p>â€¢ Ø§Ù„ØµÙŠØºØ© Ø§Ù„Ù…ØªÙˆÙ‚Ø¹Ø©: Ø§Ù„Ø§Ø³Ù…ØŒ Ø§Ù„ÙØ¦Ø©ØŒ Ø§Ù„Ø³Ø¹Ø±ØŒ Ø§Ù„Ù…Ø®Ø²ÙˆÙ† (Ù…ÙØµÙˆÙ„Ø© Ø¨ÙØ§ØµÙ„Ø©)</p>
        <p>â€¢ Ù…Ø«Ø§Ù„: Ø´ØªÙ„Ø© Ø²ÙŠØªÙˆÙ†,Ø£Ø´Ø¬Ø§Ø± Ù…Ø«Ù…Ø±Ø©,1500,25</p>
        <p>â€¢ ÙŠÙ…ÙƒÙ†Ùƒ Ù†Ø³Ø® Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Excel Ø£Ùˆ Ø£ÙŠ Ø¬Ø¯ÙˆÙ„ Ø¨ÙŠØ§Ù†Ø§Øª</p>
      </div>
      <textarea class="import-area" id="importData" placeholder="Ø§Ù„ØµÙ‚ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ù‡Ù†Ø§..."></textarea>
      <div class="btn-group">
        <button id="processImportBtn" class="btn-save"><i class="fa-solid fa-upload"></i> Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
        <button id="cancelImportBtn" class="btn btn-outline"><i class="fa-solid fa-times"></i> Ø¥Ù„ØºØ§Ø¡</button>
      </div>
      <div id="importResults" style="margin-top: 16px; display: none;"></div>
    </div>
  </div>

  <script>
    // ===== Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª API =====
    const API_URL = "https://script.google.com/macros/s/AKfycbxMYSinB7TRS-wtpunBOT9Telb6pKAMvuRTWfc12elRnvcwsO0VUT1s0arOfG-S9-vPHA/exec"; // Web App URL

    // ÙˆØ§Ø¬Ù‡Ø© Ù…ÙˆØ­Ø¯Ø© Ù„Ù„Ø·Ù„Ø¨Ø§Øª
    async function apiGet(sheet){
      const url = `${API_URL}?sheet=${encodeURIComponent(sheet)}`;
      const res = await fetch(url);
      if(!res.ok) throw new Error('GET failed');
      return res.json();
    }
    async function apiPost(payload){
      const res = await fetch(API_URL,{method:'POST',body:JSON.stringify(payload)});
      if(!res.ok) throw new Error('POST failed');
      return res.text();
    }

    // ØªØ¨ÙˆÙŠØ¨Ø§Øª
    const tabButtons = document.querySelectorAll('.tab');
    tabButtons.forEach(btn=>btn.addEventListener('click',()=>{
      tabButtons.forEach(b=>b.classList.remove('active'));
      btn.classList.add('active');
      const id = btn.dataset.tab;
      document.querySelectorAll('main > section').forEach(s=>s.hidden=true);
      document.getElementById(id).hidden = false;
    }));

    // ØªØ­Ù…ÙŠÙ„ Ø£ÙˆÙ„ÙŠ + Ø²Ø± ØªØ­Ø¯ÙŠØ«
    document.getElementById('refreshBtn').addEventListener('click', init);

    // Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Ø§Ù„Ø°Ø§ÙƒØ±Ø©
    let PRODUCTS=[], CATEGORIES=[], ORDERS=[];

    async function init(){
      try{
        showLoading(true);
        
        // Ù…Ù„Ø§Ø­Ø¸Ø©: Ù†ØªÙˆÙ‚Ø¹ Ù…Ù† ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ÙˆÙŠØ¨ ÙÙŠ Apps Script Ø£Ù† ÙŠØ¯Ø¹Ù… ?sheet=products / categories / orders
        const [products,categories,orders] = await Promise.all([
          apiGet('products'), apiGet('categories'), apiGet('orders')
        ]);
        
        PRODUCTS = normalizeRows(products, ['id', 'name', 'category', 'price', 'stock', 'image', 'desc']);
        CATEGORIES = normalizeRows(categories, ['id', 'name', 'desc']);
        ORDERS = normalizeRows(orders, ['id', 'customerName', 'phone', 'items', 'total', 'status', 'date']);

        renderCategoriesSelect();
        renderProductsTable();
        renderCategoriesTable();
        renderOrdersTable();
        renderCharts();
        
        showLoading(false);
      }catch(err){
        console.error(err);
        showLoading(false);
        alert('ØªØ¹Ø°Ø± Ø§Ù„Ø¬Ù„Ø¨ Ù…Ù† Google Sheets. ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† ØµÙ„Ø§Ø­ÙŠØ§Øª Web App ÙˆØ¨Ù†ÙŠØ© Ø§Ù„Ø£ÙˆØ±Ø§Ù‚.');
      }
    }

    // Ø¥Ø¸Ù‡Ø§Ø±/Ø¥Ø®ÙØ§Ø¡ ØªØ­Ù…ÙŠÙ„
    function showLoading(show) {
      document.getElementById('loading').hidden = !show;
    }

    // ØªØ­ÙˆÙŠÙ„ Ù…ØµÙÙˆÙØ© Ø§Ù„ØµÙÙˆÙ Ø¥Ù„Ù‰ ÙƒØ§Ø¦Ù†Ø§Øª Ù…Ø¹ Ø£Ø¹Ù…Ø¯Ø© Ù…Ø­Ø¯Ø¯Ø©
    function normalizeRows(rows, expectedColumns){
      if(!rows || !rows.length) return [];
      
      // Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø§Ù„ÙØ¹Ù„ ÙƒØ§Ø¦Ù†Ø§Øª (Ù„ÙŠØ³Øª Ù…ØµÙÙˆÙØ©)
      if(!Array.isArray(rows[0])) {
        return rows;
      }
      
      // Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…ØµÙÙˆÙØ© Ù…Ù† Ø§Ù„Ù…ØµÙÙˆÙØ§Øª (ØµÙÙˆÙ Ù…Ø¹ Ø¹Ù†Ø§ÙˆÙŠÙ†)
      const headers = rows[0];
      const out = [];
      
      for(let i = 1; i < rows.length; i++){
        const obj = {};
        headers.forEach((h, idx) => {
          // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„Ù…ØªÙˆÙ‚Ø¹Ø© Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù…ØªÙˆÙØ±Ø©
          const colName = expectedColumns[idx] || h;
          obj[colName] = rows[i][idx];
        });
        out.push(obj);
      }
      return out;
    }

    // ===== Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª =====
    function renderCategoriesSelect(){
      const sel = document.getElementById('p_category');
      sel.innerHTML = '<option value="">â€” Ø§Ø®ØªØ± ÙØ¦Ø© â€”</option>' + 
        CATEGORIES.map(c => `<option value="${c.name}">${c.name}</option>`).join('');
    }

    function renderProductsTable(){
      const body = document.getElementById('productsBody');
      
      if(!PRODUCTS.length) {
        body.innerHTML = '<tr><td colspan="6" style="text-align:center;padding:20px">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù†ØªØ¬Ø§Øª</td></tr>';
        return;
      }
      
      body.innerHTML = '';
      PRODUCTS.forEach((p,idx)=>{
        const id = p.id || idx;
        const name = p.name || '';
        const category = p.category || '';
        const price = p.price || 0;
        const stock = p.stock || 0;
        
        body.insertAdjacentHTML('beforeend',`
          <tr>
            <td>${idx+1}</td>
            <td>${name}</td>
            <td>${category}</td>
            <td>${price} Ø¯Ø¬</td>
            <td>${stock}</td>
            <td class="row-actions">
              <button class="btn" onclick="editProduct('${id}')"><i class='fa-regular fa-pen-to-square'></i> ØªØ¹Ø¯ÙŠÙ„</button>
              <button class="btn btn-danger" onclick="deleteProduct('${id}')"><i class='fa-regular fa-trash-can'></i> Ø­Ø°Ù</button>
            </td>
          </tr>
        `);
      });
    }

    // Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬
    document.getElementById('addProductBtn').addEventListener('click', async ()=>{
      const payload = {
        action:'addProduct',
        name: document.getElementById('p_name').value.trim(),
        category: document.getElementById('p_category').value,
        price: +document.getElementById('p_price').value||0,
        stock: +document.getElementById('p_stock').value||0,
        image: document.getElementById('p_image').value.trim(),
        desc: document.getElementById('p_desc').value.trim(),
      };
      
      if(!payload.name || !payload.category){ 
        return alert('Ø§Ù„Ø§Ø³Ù… ÙˆØ§Ù„ÙØ¦Ø© Ù…Ø·Ù„ÙˆØ¨Ø§Ù†'); 
      }
      
      try{
        const msg = await apiPost(payload);
        alert(msg||'ØªÙ…Øª Ø§Ù„Ø¥Ø¶Ø§ÙØ©');
        document.getElementById('resetProductForm').click();
        init();
      }catch(e){ 
        alert('ØªØ¹Ø°Ø± Ø§Ù„Ø¥Ø¶Ø§ÙØ©'); 
      }
    });
    
    document.getElementById('resetProductForm').addEventListener('click',()=>{
      ['p_name','p_category','p_price','p_stock','p_image','p_desc'].forEach(id=>{
        document.getElementById(id).value='';
      });
    });

    // ØªØ¹Ø¯ÙŠÙ„/Ø­Ø°Ù Ù…Ù†ØªØ¬
    window.editProduct = async function(id){
      const p = PRODUCTS.find(x => (x.id == id));
      if(!p){return alert('Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ù…Ù†ØªØ¬');}
      
      const newPrice = prompt('Ø£Ø¯Ø®Ù„ Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø¬Ø¯ÙŠØ¯', p.price || 0);
      if(newPrice===null) return;
      
      const newStock = prompt('Ø£Ø¯Ø®Ù„ Ø§Ù„Ù…Ø®Ø²ÙˆÙ† Ø§Ù„Ø¬Ø¯ÙŠØ¯', p.stock || 0);
      if(newStock===null) return;
      
      try{
        const msg = await apiPost({action:'updateProduct', id, price:+newPrice, stock:+newStock});
        alert(msg||'ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ«');
        init();
      }catch(e){ 
        alert('ØªØ¹Ø°Ø± Ø§Ù„ØªØ­Ø¯ÙŠØ«'); 
      }
    }
    
    window.deleteProduct = async function(id){
      if(!confirm('ØªØ£ÙƒÙŠØ¯ Ø­Ø°Ù Ø§Ù„Ù…Ù†ØªØ¬ØŸ')) return;
      
      try{
        const msg = await apiPost({action:'deleteProduct', id});
        alert(msg||'ØªÙ… Ø§Ù„Ø­Ø°Ù');
        init();
      }catch(e){ 
        alert('ØªØ¹Ø°Ø± Ø§Ù„Ø­Ø°Ù'); 
      }
    }

    // ===== Ø§Ù„ÙØ¦Ø§Øª =====
    function renderCategoriesTable(){
      const body = document.getElementById('categoriesBody');
      
      if(!CATEGORIES.length) {
        body.innerHTML = '<tr><td colspan="4" style="text-align:center;padding:20px">Ù„Ø§ ØªÙˆØ¬Ø¯ ÙØ¦Ø§Øª</td></tr>';
        return;
      }
      
      body.innerHTML = '';
      CATEGORIES.forEach((c,idx)=>{
        const id = c.id || idx;
        const name = c.name || '';
        const desc = c.desc || '';
        
        body.insertAdjacentHTML('beforeend',`
          <tr>
            <td>${idx+1}</td>
            <td>${name}</td>
            <td>${desc}</td>
            <td class="row-actions">
              <button class="btn btn-danger" onclick="deleteCategory('${id}')"><i class='fa-regular fa-trash-can'></i> Ø­Ø°Ù</button>
            </td>
          </tr>
        `);
      });
    }

    document.getElementById('addCategoryBtn').addEventListener('click', async ()=>{
      const name = document.getElementById('c_name').value.trim();
      const desc = document.getElementById('c_desc').value.trim();
      
      if(!name) return alert('Ø§Ø³Ù… Ø§Ù„ÙØ¦Ø© Ù…Ø·Ù„ÙˆØ¨');
      
      try{
        const msg = await apiPost({action:'addCategory', name, desc});
        alert(msg||'ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø§Ù„ÙØ¦Ø©');
        document.getElementById('c_name').value='';
        document.getElementById('c_desc').value='';
        init();
      }catch(e){ 
        alert('ØªØ¹Ø°Ø± Ø¥Ø¶Ø§ÙØ© Ø§Ù„ÙØ¦Ø©'); 
      }
    });

    window.deleteCategory = async function(id){
      if(!confirm('ØªØ£ÙƒÙŠØ¯ Ø­Ø°Ù Ø§Ù„ÙØ¦Ø©ØŸ Ø³ÙŠØ¤Ø«Ø± Ø¹Ù„Ù‰ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø©.')) return;
      
      try{
        const msg = await apiPost({action:'deleteCategory', id});
        alert(msg||'ØªÙ… Ø­Ø°Ù Ø§Ù„ÙØ¦Ø©');
        init();
      }catch(e){ 
        alert('ØªØ¹Ø°Ø± Ø­Ø°Ù Ø§Ù„ÙØ¦Ø©'); 
      }
    }

    // ===== Ø§Ù„Ø·Ù„Ø¨Ø§Øª =====
    function renderOrdersTable(){
      const body = document.getElementById('ordersBody');
      
      if(!ORDERS.length) {
        body.innerHTML = '<tr><td colspan="8" style="text-align:center;padding:20px">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª</td></tr>';
        return;
      }
      
      body.innerHTML='';
      ORDERS.forEach((o,idx)=>{
        const id = o.id || idx;
        const name = o.customerName || '';
        const phone = (o.phone || '').toString();
        const items = o.items || '';
        const total = o.total || '';
        const status = o.status || 'Ø¬Ø¯ÙŠØ¯';
        const date = o.date || '';
        const wa = normalizeDZ(phone);
        
        body.insertAdjacentHTML('beforeend',`
          <tr>
            <td>${idx+1}</td>
            <td>${name}</td>
            <td><a href="https://wa.me/${wa}?text=${encodeURIComponent('Ù…Ø±Ø­Ø¨Ø§Ù‹ØŒ Ø¨Ø®ØµÙˆØµ Ø·Ù„Ø¨ÙƒÙ… Ù…Ù† Ù…Ø´ØªÙ„Ø© Ø§Ù„Ø³Ù„Ø§Ù…: '+items+' â€” Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: '+total)}" target="_blank">${phone}</a></td>
            <td>${items}</td>
            <td>${total} Ø¯Ø¬</td>
            <td><span class="badge">${status}</span></td>
            <td>${formatDate(date)}</td>
            <td class="row-actions">
              <button class="btn" onclick="updateOrder('${id}','Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©')">Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©</button>
              <button class="btn" onclick="updateOrder('${id}','Ù…ÙƒØªÙ…Ù„')">Ù…ÙƒØªÙ…Ù„</button>
            </td>
          </tr>
        `);
      });
    }

    function normalizeDZ(phone){
      // ÙŠØ­ÙˆÙ„ 069xxxx Ø¥Ù„Ù‰ 21369xxxx Ù„Ù„ØªÙˆØ§ÙÙ‚ Ù…Ø¹ wa.me
      let p = phone.replace(/\D/g,'');
      if(p.startsWith('0')) p = '213'+p.slice(1);
      if(p.startsWith('00213')) p = '213'+p.slice(5);
      return p;
    }
    
    function formatDate(d){ 
      try{ 
        return new Date(d).toLocaleDateString('ar-DZ'); 
      }catch{ 
        return d||''; 
      } 
    }

    async function updateOrder(id,status){
      try{
        const msg = await apiPost({action:'updateOrder', id, status});
        alert(msg||'ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø©');
        init();
      }catch(e){ 
        alert('ØªØ¹Ø°Ø± ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø·Ù„Ø¨'); 
      }
    }

    // ===== Ø§Ù„Ø±Ø³ÙˆÙ… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠØ© =====
    let chartOrdersMonthly, chartTopProducts;
    function renderCharts(){
      // ØªØ¯Ù…ÙŠØ± Ù‚Ø¯ÙŠÙ…
      if(chartOrdersMonthly) chartOrdersMonthly.destroy();
      if(chartTopProducts) chartTopProducts.destroy();

      // 1) Ø¹Ø¯Ø¯ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø´Ù‡Ø±ÙŠÙ‹Ø§
      const monthly = {};
      ORDERS.forEach(o=>{
        const d = new Date(o.date||Date.now());
        const key = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
        monthly[key] = (monthly[key]||0)+1;
      });
      const labelsM = Object.keys(monthly).sort();
      const dataM = labelsM.map(k=>monthly[k]);
      
      const ordersCtx = document.getElementById('ordersMonthly');
      if(ordersCtx) {
        chartOrdersMonthly = new Chart(ordersCtx,{
          type:'line',
          data:{ labels:labelsM, datasets:[{ label:'Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø´Ù‡Ø±ÙŠÙ‹Ø§', data:dataM, borderColor:'#2e7d32', backgroundColor:'rgba(46, 125, 50, 0.1)' }] },
          options:{ responsive:true, plugins:{ legend:{ display:true } } }
        });
      }

      // 2) Ø£ÙƒØ«Ø± Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª ØªÙƒØ±Ø§Ø±Ù‹Ø§ ÙÙŠ Ø§Ù„Ø·Ù„Ø¨Ø§Øª
      const counts = {};
      ORDERS.forEach(o=>{
        const raw = (o.items||'');
        raw.split(',').map(s=>s.trim()).filter(Boolean).forEach(name=>{
          // ÙŠØ­Ø°Ù Ø§Ù„ÙƒÙ…ÙŠØ§Øª Ù…Ø«Ù„ Ã—2
          const base = name.replace(/Ã—\s*\d+/,'').trim();
          counts[base]=(counts[base]||0)+1;
        })
      });
      const labelsT = Object.keys(counts);
      const dataT = labelsT.map(k=>counts[k]);
      
      const productsCtx = document.getElementById('topProducts');
      if(productsCtx) {
        chartTopProducts = new Chart(productsCtx,{
          type:'bar',
          data:{ labels:labelsT, datasets:[{ label:'ØªÙƒØ±Ø§Ø± Ø§Ù„Ø¨ÙŠØ¹', data:dataT, backgroundColor:'#81c784' }] },
          options:{ indexAxis: labelsT.length>6 ? 'y' : 'x', plugins:{ legend:{display:true} } }
        });
      }
    }

    // ===== Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª =====
    const importModal = document.getElementById('importModal');
    const importBtn = document.getElementById('importProductsBtn');
    const closeBtn = document.getElementsByClassName('close')[0];
    const cancelImportBtn = document.getElementById('cancelImportBtn');
    const processImportBtn = document.getElementById('processImportBtn');
    const importData = document.getElementById('importData');
    const importResults = document.getElementById('importResults');

    // ÙØªØ­ Ø§Ù„Ù…ÙˆØ¯Ø§Ù„
    importBtn.onclick = function() {
      importModal.style.display = 'block';
      importData.value = '';
      importResults.style.display = 'none';
    }

    // Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù…ÙˆØ¯Ø§Ù„
    closeBtn.onclick = function() {
      importModal.style.display = 'none';
    }

    cancelImportBtn.onclick = function() {
      importModal.style.display = 'none';
    }

    // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªÙˆØ±Ø¯Ø©
    processImportBtn.onclick = async function() {
      const data = importData.value.trim();
      if (!data) {
        alert('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯');
        return;
      }

      const lines = data.split('\n').filter(line => line.trim() !== '');
      let successCount = 0;
      let errorCount = 0;
      let errorMessages = [];

      importResults.innerHTML = '<p>Ø¬Ø§Ø±ÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</p>';
      importResults.style.display = 'block';

      for (let i = 0; i < lines.length; i++) {
        const line = lines[i].trim();
        const parts = line.split(',').map(part => part.trim());
        
        if (parts.length < 4) {
          errorCount++;
          errorMessages.push(`Ø§Ù„Ø³Ø·Ø± ${i+1}: ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø¹Ø¯Ø¯ ØºÙŠØ± ÙƒØ§Ù Ù…Ù† Ø§Ù„Ø­Ù‚ÙˆÙ„ (${parts.length} Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† 4)`);
          continue;
        }

        const [name, category, price, stock] = parts;

        if (!name || !category) {
          errorCount++;
          errorMessages.push(`Ø§Ù„Ø³Ø·Ø± ${i+1}: Ø§Ù„Ø§Ø³Ù… ÙˆØ§Ù„ÙØ¦Ø© Ù…Ø·Ù„ÙˆØ¨Ø§Ù†`);
          continue;
        }

        const payload = {
          action: 'addProduct',
          name: name,
          category: category,
          price: parseInt(price) || 0,
          stock: parseInt(stock) || 0,
          image: '',
          desc: ''
        };

        try {
          const msg = await apiPost(payload);
          successCount++;
        } catch (e) {
          errorCount++;
          errorMessages.push(`Ø§Ù„Ø³Ø·Ø± ${i+1}: ØªØ¹Ø°Ø± Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù†ØªØ¬ - ${e.message}`);
        }
      }

      // Ø¹Ø±Ø¶ Ø§Ù„Ù†ØªØ§Ø¦Ø¬
      importResults.innerHTML = `
        <h3>Ù†ØªÙŠØ¬Ø© Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯</h3>
        <p>âœ… ØªÙ… Ø§Ø³ØªÙŠØ±Ø§Ø¯ ${successCount} Ù…Ù†ØªØ¬ Ø¨Ù†Ø¬Ø§Ø­</p>
        <p>âŒ ÙØ´Ù„ Ø§Ø³ØªÙŠØ±Ø§Ø¯ ${errorCount} Ù…Ù†ØªØ¬</p>
        ${errorMessages.length > 0 ? `<details><summary>Ø¹Ø±Ø¶ Ø§Ù„ØªÙØ§ØµÙŠÙ„</summary><ul>${errorMessages.map(msg => `<li>${msg}</li>`).join('')}</ul></details>` : ''}
        <div class="btn-group">
          <button class="btn-save" onclick="importModal.style.display='none'; init();">ØªÙ…</button>
        </div>
      `;
    }

    // Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù†Ø§ÙØ°Ø© Ø¹Ù†Ø¯ Ø§Ù„Ù†Ù‚Ø± Ø®Ø§Ø±Ø¬Ù‡Ø§
    window.onclick = function(event) {
      if (event.target == importModal) {
        importModal.style.display = 'none';
      }
    }

    // ØªØ´ØºÙŠÙ„ Ø£ÙˆÙ„ÙŠ
    init();
  </script>
</body>
</html>