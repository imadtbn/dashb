<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>مشتلة السلام</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <style>
    body{font-family:'Tajawal',Arial,sans-serif;margin:0;background:#f9fff9;scroll-behavior:smooth}
    header{background:#2e7d32;color:#fff;padding:1rem;position:sticky;top:0;z-index:1000}
    header h1{margin:0}
    nav{margin-top:.5rem;display:flex;gap:1rem;justify-content:center;flex-wrap:wrap}
    nav a{color:#fff;text-decoration:none;font-weight:bold}
    nav a:hover{text-decoration:underline}
    nav .dropdown{position:relative}
    nav .dropdown-content{display:none;position:absolute;background:#fff;color:#000;min-width:160px;box-shadow:0 2px 5px rgba(0,0,0,0.3);z-index:999}
    nav .dropdown-content a{color:#000;display:block;padding:.5rem;text-align:right}
    nav .dropdown-content a:hover{background:#f1f1f1}
    nav .dropdown:hover .dropdown-content{display:block}

    /* محرك البحث */
    #search-bar{display:flex;justify-content:center;margin:1rem;position:relative}
    #search-input{width:80%;max-width:500px;padding:.7rem 2.5rem .7rem .7rem;border:1px solid #ccc;border-radius:20px;text-align:right}
    #search-bar i{position:absolute;right:calc(10% + 15px);top:50%;transform:translateY(-50%);color:#888}

    /* زر السلة */
    .cart-header{display:flex;justify-content:center;margin-bottom:1rem}
    .cart-btn{background:#2e7d32;color:#fff;padding:1rem 2rem;border:none;border-radius:30px;font-size:1.2rem;cursor:pointer;display:flex;align-items:center;gap:.7rem}
    .cart-btn:hover{background:#1b5e20}

    /* شريط السلة */
.cart-bar {
  background:#e8f5e9;
  padding:.7rem 1rem;
  display:flex;
  justify-content:space-between;
  align-items:center;
  font-weight:bold;
  position:sticky;
  top:80px; /* يظهر أسفل الهيدر */
  z-index:1200;
  border:1px solid #c8e6c9;
  border-radius:8px;
  margin:0 1rem;
}
    .cart-bar button{background:#2e7d32;color:#fff;border:none;padding:.5rem 1rem;border-radius:15px;cursor:pointer}
    .cart-bar button:hover{background:#1b5e20}

    /* المنتجات */
    .category{padding:1rem}
    .category:not(:first-child){border-top:3px solid #2e7d32;margin-top:1rem;padding-top:1.5rem}
    .products{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:1rem}
    .card{background:#fff;border:1px solid #ddd;border-radius:10px;padding:1rem;text-align:center;box-shadow:0 2px 5px rgba(0,0,0,0.05)}
    .card img{width:100%;height:150px;object-fit:cover;border-radius:8px}
    .btn{background:#2e7d32;color:#fff;border:none;padding:.5rem 1rem;border-radius:5px;cursor:pointer;margin-top:.5rem}
    .btn:hover{background:#1b5e20}

    /* مودال السلة */
    .modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);justify-content:center;align-items:center;z-index:2000}
    .modal-content{background:#fff;padding:1rem;border-radius:8px;width:90%;max-width:600px;max-height:90%;overflow:auto;position:relative}
    .modal-header{display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid #ddd;padding-bottom:.5rem;margin-bottom:.5rem}
    .modal-header h3{margin:0}
    .modal-header button{background:none;border:none;font-size:1.2rem;cursor:pointer}
    #cart-table{width:100%;border-collapse:collapse;margin-bottom:.5rem}
    #cart-table th,#cart-table td{border:1px solid #ddd;padding:.3rem;text-align:center}
    #cart-table input{width:50px}
    #cart-table .remove{color:red;cursor:pointer}
    #checkout{margin-top:1rem}
    .form-group{margin:.5rem 0}
    .form-group input{width:100%;padding:.5rem;border:1px solid #ccc;border-radius:5px}
    .checkout-btns{display:flex;gap:.5rem;flex-wrap:wrap;margin-top:.5rem}
    .checkout-btns button{flex:1}

    /* Toast */
    #toast{visibility:hidden;min-width:250px;background:#2e7d32;color:#fff;text-align:center;border-radius:5px;padding:1rem;position:fixed;bottom:30px;right:30px;z-index:3000;font-weight:bold}
    #toast.show{visibility:visible;animation:fadein .5s, fadeout .5s 2.5s}
    @keyframes fadein{from{bottom:0;opacity:0}to{bottom:30px;opacity:1}}
    @keyframes fadeout{from{bottom:30px;opacity:1}to{bottom:0;opacity:0}}

    /* سهم للأعلى */
    #back-to-top{position:fixed;bottom:20px;left:20px;background:#2e7d32;color:#fff;padding:.7rem;border-radius:50%;cursor:pointer;display:none;z-index:3000}
    #back-to-top:hover{background:#1b5e20}

    /* فوتر */
    footer{background:#2e7d32;color:#dfeede;display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:1rem;padding:1rem;text-align:right;margin-top:2rem}
    footer h4{margin-bottom:.5rem;color:#fff}
    footer a{color:#dfeede;text-decoration:none;display:block;margin:.2rem 0}
    footer a:hover{text-decoration:underline}
    .shop-btn{margin-top:.5rem;display:inline-block;background:#fff;color:#2e7d32;padding:.5rem 1rem;border-radius:20px;text-decoration:none;font-weight:bold}
    .shop-btn:hover{background:#e0e0e0}
  </style>
</head>
<body>

<header>
  <h1><i class="fas fa-seedling"></i> مشتلة السلام</h1>
  <nav>
    <div class="dropdown">
      <a href="#products">🌱 منتجاتنا</a>
      <div class="dropdown-content" id="categories-menu"><a>جارٍ التحميل...</a></div>
    </div>
    <a href="#about">عن المشتلة</a>
    <a href="#contact">تواصل معنا</a>
  </nav>
  <div id="search-bar">
    <input type="text" id="search-input" placeholder="ابحث عن منتج..." oninput="filterProducts()">
    <i class="fas fa-search"></i>
  </div>
  <div class="cart-header">
    <button class="cart-btn" onclick="openCart()"><i class="fas fa-shopping-cart"></i> السلة</button>
  </div>
</header>

<!-- شريط السلة -->
<div class="cart-bar">
  <span>🛒 العناصر: <span id="cart-count">0</span> | 💰 المجموع: <span id="cart-sum">0</span> دج</span>
  <button onclick="openCart()">عرض الفاتورة</button>
</div>

<main id="categories-container">
  <p style="text-align:center;padding:2rem;">⏳ جارٍ تحميل المنتجات...</p>
</main>

<!-- مودال السلة -->
<div class="modal" id="cartModal">
  <div class="modal-content">
    <div class="modal-header">
      <h3><i class="fas fa-shopping-cart"></i> السلة</h3>
      <div>
        <button onclick="clearCart()" title="إفراغ السلة"><i class="fas fa-trash"></i></button>
        <button onclick="closeCart()" title="إغلاق"><i class="fas fa-times"></i></button>
      </div>
    </div>
    <table id="cart-table">
      <thead><tr><th>المنتج</th><th>الكمية</th><th>السعر</th><th>حذف</th></tr></thead>
      <tbody id="cart-body"></tbody>
      <tfoot><tr><td colspan="2">المجموع</td><td id="cart-total">0</td><td></td></tr></tfoot>
    </table>
    <div id="checkout">
      <h4>معلومات الزبون</h4>
      <div class="form-group"><input id="customerName" placeholder="👤 الاسم الكامل"></div>
      <div class="form-group"><input id="customerPhone" placeholder="📞 رقم الهاتف"></div>
      <div class="form-group"><input id="customerAddress" placeholder="📍 العنوان"></div>
      <div class="checkout-btns">
        <button class="btn" onclick="checkout('whatsapp')"><i class="fab fa-whatsapp"></i> شراء عبر واتساب</button>
        <button class="btn" onclick="checkout('google')"><i class="fas fa-credit-card"></i> شراء عبر Google</button>
      </div>
    </div>
  </div>
</div>

<!-- Toast -->
<div id="toast"></div>

<!-- سهم للأعلى -->
<div id="back-to-top" onclick="window.scrollTo({top:0,behavior:'smooth'})"><i class="fas fa-arrow-up"></i></div>

<footer>
  <div>
    <h4><i class="fas fa-store"></i> مشتلة السلام</h4>
    <p>أجود أنواع الشتلات والخدمات الزراعية</p>
    <a href="#" class="shop-btn"><i class="fas fa-map-marker-alt"></i> توجه إلى المشتل</a>
  </div>
  <div>
    <h4><i class="fas fa-map-marker-alt"></i> العنوان</h4>
    <p>حي السلام - الجزائر</p>
    <h4><i class="fas fa-phone"></i> الهاتف</h4>
    <p>0697 743 721</p>
  </div>
  <div>
    <h4><i class="fas fa-share-alt"></i> تابعنا</h4>
    <a href="#"><i class="fab fa-facebook"></i> فيسبوك</a>
    <a href="#"><i class="fab fa-instagram"></i> إنستغرام</a>
    <a href="#"><i class="fab fa-whatsapp"></i> واتساب</a>
  </div>
  <div>
    <h4><i class="fas fa-cogs"></i> خدماتنا</h4>
    <p>🌱 بيع الشتلات</p>
    <p>🚚 التوصيل</p>
    <p>🛠️ الاستشارات الزراعية</p>
  </div>
</footer>

<script>
const API_URL="https://script.google.com/macros/s/AKfycbxMYSinB7TRS-wtpunBOT9Telb6pKAMvuRTWfc12elRnvcwsO0VUT1s0arOfG-S9-vPHA/exec";
let allProducts=[],cart=[];

async function loadProducts(){
  const res=await fetch(API_URL+"?sheet=products");
  allProducts=await res.json();
  renderProducts(allProducts);
  renderCategoriesMenu(allProducts);
}

function renderProducts(products){
  const container=document.getElementById("categories-container");
  container.innerHTML="";
  const grouped={};
  products.forEach(p=>{
    const cat=(p["الفئة "]||"غير مصنف").trim();
    (grouped[cat] ||= []).push(p);
  });
  Object.entries(grouped).forEach(([cat,items])=>{
    const section=document.createElement("section");
    section.className="category";
    section.innerHTML=`<div class="category-header"><h2><i class="fas fa-leaf"></i> ${cat}</h2></div><div class="products"></div>`;
    const wrap=section.querySelector(".products");
    items.forEach(p=>{
      const card=document.createElement("div");
      card.className="card";
      card.innerHTML=`
        <img src="${p["رابط الصورة"]||'https://via.placeholder.com/200x150'}">
        <h3>${p["اسم المنتج"]}</h3>
        <p>${p["السعر "]} دج</p>
        <button class="btn"><i class="fas fa-cart-plus"></i> إضافة للسلة</button>`;
      card.querySelector("button").onclick=()=>addToCart(p);
      wrap.appendChild(card);
    });
    container.appendChild(section);
  });
}

function renderCategoriesMenu(products){
  const menu=document.getElementById("categories-menu");
  menu.innerHTML="";
  const cats=[...new Set(products.map(p=>(p["الفئة "]||"غير مصنف").trim()))];
  cats.forEach(cat=>{
    const a=document.createElement("a");
    a.href="#";a.textContent=cat;
    a.onclick=()=>filterByCategory(cat);
    menu.appendChild(a);
  });
}

function filterProducts(){
  const q=document.getElementById("search-input").value.trim();
  const results=allProducts.filter(p=>p["اسم المنتج"].includes(q)||p["الفئة "].includes(q));
  renderProducts(results);
}
function filterByCategory(cat){
  const results=allProducts.filter(p=>(p["الفئة "]||"").trim()===cat);
  renderProducts(results);
}

function addToCart(product){
  const existing=cart.find(i=>i.id===product.id);
  if(existing){existing.qty++;}
  else{cart.push({id:product.id,name:product["اسم المنتج"],price:product["السعر "],qty:1});}
  renderCart();
  showToast(`✅ تم إضافة ${product["اسم المنتج"]} للسلة`);
}

function renderCart(){
  const body=document.getElementById("cart-body");body.innerHTML="";
  let total=0,count=0;
  cart.forEach(item=>{
    total+=item.price*item.qty;count+=item.qty;
    const tr=document.createElement("tr");
    tr.innerHTML=`<td>${item.name}</td>
      <td><input type="number" value="${item.qty}" min="1" onchange="updateQty(${item.id},this.value)"></td>
      <td>${item.price*item.qty}</td>
      <td><span class="remove" onclick="removeFromCart(${item.id})"><i class="fas fa-times-circle"></i></span></td>`;
    body.appendChild(tr);
  });
  document.getElementById("cart-total").innerText=total;
  document.getElementById("cart-count").innerText=count;
  document.getElementById("cart-sum").innerText=total;
}

function updateQty(id,val){
  const it=cart.find(i=>i.id===id);
  if(it){it.qty=parseInt(val)||1;}
  renderCart();
}
function removeFromCart(id){cart=cart.filter(i=>i.id!==id);renderCart();}
function clearCart(){cart=[];renderCart();}

function openCart(){document.getElementById("cartModal").style.display="flex";}
function closeCart(){document.getElementById("cartModal").style.display="none";}

function checkout(method){
  const name=document.getElementById("customerName").value.trim();
  const phone=document.getElementById("customerPhone").value.trim();
  const address=document.getElementById("customerAddress").value.trim();
  if(!name||!phone||cart.length===0){alert("⚠️ أدخل البيانات وأضف منتجات");return;}
  const itemsStr=cart.map(i=>`${i.name} x${i.qty}`).join(", ");
  const total=cart.reduce((s,i)=>s+i.price*i.qty,0);

  fetch(API_URL,{method:"POST",body:JSON.stringify({action:"addOrder",customerName:name,phone,customerAddress:address,items:itemsStr,total:total,status:"جديد"})});

  if(method==="whatsapp"){
    const msg=`طلب جديد:%0A👤 ${name}%0A📞 ${phone}%0A📍 ${address}%0A🛒 ${itemsStr}%0A💰 ${total} دج`;
    window.open(`https://wa.me/213697743721?text=${msg}`,"_blank");
  }else{alert("✅ تم إرسال الطلب إلى المشتلة بنجاح!");}
  cart=[];renderCart();closeCart();
}

function showToast(msg){
  const toast=document.getElementById("toast");
  toast.innerText=msg;
  toast.className="show";
  setTimeout(()=>toast.className=toast.className.replace("show",""),3000);
}

window.onscroll=()=>{document.getElementById("back-to-top").style.display=window.scrollY>200?"block":"none";}
loadProducts();
</script>

</body>
</html>
